<!DOCTYPE html>
<html lang="fr">
<head>

<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Nightshift</title>

<!-- PWA -->
<link rel="apple-touch-icon" href="192.png">
<link rel="apple-touch-icon" sizes="512x512" href="512.png">
<meta name="apple-mobile-web-app-capable" content="yes">

<!-- OCR -->
<script src="https://cdn.jsdelivr.net/npm/tesseract.js@5/dist/tesseract.min.js"></script>

<style>

/* === THEME === */

:root{
  --bg:#071420;
  --card:#0e2236;
  --accent:#21d4c2;
  --accent2:#2ea1ff;
  --ok:#2ecc71;
  --warn:#f39c12;
  --text:#eaf4ff;
  --muted:#7c91ad;
}

body{
  margin:0;
  background:var(--bg);
  color:var(--text);
  font-family:-apple-system,BlinkMacSystemFont,sans-serif;
}

/* Background */

body::before{
  content:"";
  position:fixed;
  inset:0;
  background:
    radial-gradient(circle at 20% 30%, rgba(0,200,180,.15), transparent 40%),
    radial-gradient(circle at 80% 60%, rgba(0,120,255,.15), transparent 40%),
    radial-gradient(circle at 50% 80%, rgba(0,180,120,.12), transparent 50%);
  z-index:-1;
}

/* Header */

header{
  text-align:center;
  padding:14px;
  background:#081a2c;
  border-bottom:1px solid #143458;
}

/* Layout */

main{
  max-width:750px;
  margin:auto;
  padding:12px;
}

.card{
  background:var(--card);
  border-radius:14px;
  padding:14px;
  margin-bottom:14px;
  box-shadow:0 0 15px rgba(0,0,0,.4);
}

.hidden{display:none;}

label{
  display:block;
  margin-top:10px;
}

input,select{
  width:100%;
  padding:10px;
  margin-top:4px;
  border:none;
  border-radius:8px;
  background:#162c46;
  color:var(--text);
}

button{
  width:100%;
  padding:12px;
  margin-top:12px;
  border:none;
  border-radius:10px;
  font-weight:600;
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#001018;
}

/* Nav */

.nav{
  display:flex;
  gap:6px;
}

.tab{
  flex:1;
  text-align:center;
  padding:8px;
  border-radius:8px;
  background:#162c46;
  font-size:13px;
}

.tab.active{
  background:linear-gradient(135deg,var(--accent),var(--accent2));
  color:#001018;
}

/* Lists */

.item{
  border-bottom:1px solid #1b3a5d;
  padding:8px 0;
}

.done{opacity:.4;}

.confirm{
  background:#091c2e;
  border:1px solid var(--warn);
  padding:12px;
  border-radius:10px;
  margin-top:10px;
}

</style>
</head>

<body>

<header>
  <h2>üï∂Ô∏è NIGHTSHIFT</h2>
  <small id="today"></small>
</header>

<main>

<!-- NAV -->

<div class="card nav">
  <div class="tab active" onclick="nav('mission',this)">üéØ Mission</div>
  <div class="tab" onclick="nav('call',this)">üìû Appel</div>
  <div class="tab" onclick="nav('plan',this)">üóì Planning</div>
  <div class="tab" onclick="nav('log',this)">üìã Journal</div>
  <div class="tab" onclick="nav('settings',this)">‚öôÔ∏è Param√®tres</div>
</div>


<!-- MISSION -->

<div class="card" id="mission">

<h3>üéØ Mission</h3>

<label>Scanner bracelet</label>
<input type="file" accept="image/*" capture="environment" id="scan">
<button onclick="scanBracelet()">üì∏ Scanner</button>

<label>Nom</label>
<input id="p_nom">

<label>Pr√©nom</label>
<input id="p_prenom">

<label>Date naissance</label>
<input id="p_naissance">

<label>Sexe</label>
<input id="p_sexe">

<label>IPP</label>
<input type="number" inputmode="numeric" id="p_ipp">

<label>Dossier</label>
<input type="number" inputmode="numeric" id="p_dossier">

<label>D√©part</label>
<select id="m_from"></select>

<label>Destination</label>
<select id="m_to"></select>

<label>Chambre</label>
<input type="number" inputmode="numeric" id="m_room">

<label>Mode</label>
<select id="m_mode">
  <option>Assis</option>
  <option>Couch√©</option>
  <option>Debout</option>
</select>

<label>Type</label>
<select id="m_type">
  <option>Aller</option>
  <option>Retour</option>
  <option>Aller / Retour</option>
</select>

<label>Brancardier 1</label>
<select id="m_b1"></select>

<label>Brancardier 2</label>
<select id="m_b2"></select>

<button onclick="prepareConfirm()">Valider</button>

<div id="confirmBox" class="confirm hidden">

<p>Confirmer ?</p>

<button onclick="finishMission()" style="background:var(--ok)">Oui</button>
<button onclick="cancelConfirm()">Non</button>

</div>

</div>


<!-- CALL -->

<div class="card hidden" id="call">

<h3>üìû Nouvel appel</h3>

<label>Heure</label>
<input type="time" id="c_time">

<label>Patient</label>
<input id="c_patient">

<label>D√©part</label>
<select id="c_from"></select>

<label>Destination</label>
<select id="c_to"></select>

<label>Chambre</label>
<input type="number" inputmode="numeric" id="c_room">

<button onclick="addCall()">Ajouter</button>

</div>


<!-- PLANNING -->

<div class="card hidden" id="plan">

<h3>üóì Planning</h3>
<div id="planList"></div>

</div>


<!-- JOURNAL -->

<div class="card hidden" id="log">

<h3>üìã Journal</h3>
<div id="logList"></div>

</div>


<!-- SETTINGS -->

<div class="card hidden" id="settings">

<h3>‚öôÔ∏è Param√®tres</h3>

<h4>D√©parts</h4>
<input id="set_from">
<button onclick="addSetting('from')">Ajouter</button>
<div id="list_from"></div>

<h4>Destinations</h4>
<input id="set_to">
<button onclick="addSetting('to')">Ajouter</button>
<div id="list_to"></div>

<h4>Brancardiers</h4>
<input id="set_staff">
<button onclick="addSetting('staff')">Ajouter</button>
<div id="list_staff"></div>

</div>

</main>


<script>

/* === DATA === */

let planning = JSON.parse(localStorage.getItem("ns_plan")||"[]");
let journal  = JSON.parse(localStorage.getItem("ns_log")||"[]");

let settings = JSON.parse(localStorage.getItem("ns_settings")) || {
  from:["Urgences","IRM","Scanner"],
  to:["Bloc","Radio","Chambre"],
  staff:["Jean","Paul"]
};


/* === DATE === */

function today(){
  return new Date().toISOString().split("T")[0];
}

todayEl = document.getElementById("today");
todayEl.textContent = today();


/* === NAV === */

function nav(id,el){

  document.querySelectorAll(".tab").forEach(t=>t.classList.remove("active"));
  el.classList.add("active");

  ["mission","call","plan","log","settings"].forEach(v=>{
    document.getElementById(v).classList.add("hidden");
  });

  document.getElementById(id).classList.remove("hidden");
}


/* === CALL === */

function addCall(){

  planning.push({
    id:Date.now(),
    date:today(),
    time:c_time.value,
    patient:c_patient.value,
    from:c_from.value,
    to:c_to.value,
    room:c_room.value,
    done:false
  });

  save();
  clearCall();
  render();
  nav("plan",document.querySelectorAll(".tab")[2]);
}


function clearCall(){

  ["c_time","c_patient","c_room"]
  .forEach(i=>document.getElementById(i).value="");
}


/* === RENDER === */

function render(){

  planList.innerHTML="";
  logList.innerHTML="";

  planning
  .filter(p=>p.date===today())
  .sort((a,b)=>a.time.localeCompare(b.time))
  .forEach(p=>{

    planList.innerHTML+=`
    <div class="item ${p.done?"done":""}">
      <strong>${p.time||"--:--"}</strong>
      ${p.patient}
      <div class="muted">
      ${p.from} ‚Üí ${p.to} ‚Ä¢ ${p.room}
      </div>
    </div>`;
  });


  journal
  .filter(j=>j.date===today())
  .forEach(j=>{

    logList.innerHTML+=`
    <div class="item">
      <strong>${j.time}</strong>
      ${j.nom} ${j.prenom}
      <div class="muted">
      ${j.from} ‚Üí ${j.to}
      ‚Ä¢ ${j.room}
      ‚Ä¢ ${j.mode}
      ‚Ä¢ ${j.b1} ${j.b2}
      ‚Ä¢ ${j.type}
      </div>
    </div>`;
  });

}


/* === MISSION === */

function prepareConfirm(){
  confirmBox.classList.remove("hidden");
}

function cancelConfirm(){
  confirmBox.classList.add("hidden");
}


function finishMission(){

  const m = {

    date:today(),
    time:new Date().toLocaleTimeString(),

    nom:p_nom.value,
    prenom:p_prenom.value,
    naissance:p_naissance.value,
    sexe:p_sexe.value,
    ipp:p_ipp.value,
    dossier:p_dossier.value,

    from:m_from.value,
    to:m_to.value,
    room:m_room.value,
    mode:m_mode.value,

    b1:m_b1.value,
    b2:m_b2.value,

    type:m_type.value
  };

  journal.push(m);

  save();
  clearMission();
  render();
  cancelConfirm();
}


function clearMission(){

[
"p_nom","p_prenom","p_naissance","p_sexe",
"p_ipp","p_dossier","m_room"
]
.forEach(i=>{
  const el=document.getElementById(i);
  if(el) el.value="";
});

}


/* === STORAGE === */

function save(){

  localStorage.setItem("ns_plan",JSON.stringify(planning));
  localStorage.setItem("ns_log",JSON.stringify(journal));
  localStorage.setItem("ns_settings",JSON.stringify(settings));
}


/* === SETTINGS === */

function loadSettings(){

  renderSettings();
  loadLists();
}


function renderSettings(){

  renderList("from","list_from");
  renderList("to","list_to");
  renderList("staff","list_staff");
}


function renderList(key,container){

  const box=document.getElementById(container);

  box.innerHTML="";

  settings[key].forEach((v,i)=>{

    box.innerHTML+=`
    <div class="item">
      ${v}
      <button onclick="removeSetting('${key}',${i})">‚ùå</button>
    </div>`;
  });
}


function addSetting(key){

  const map={
    from:"set_from",
    to:"set_to",
    staff:"set_staff"
  };

  const input=document.getElementById(map[key]);

  if(!input.value) return;

  settings[key].push(input.value);

  input.value="";

  save();
  loadSettings();
}


function removeSetting(key,i){

  settings[key].splice(i,1);

  save();
  loadSettings();
}


/* === SELECTS === */

function loadLists(){

  fill("m_from",settings.from);
  fill("c_from",settings.from);

  fill("m_to",settings.to);
  fill("c_to",settings.to);

  fill("m_b1",settings.staff);
  fill("m_b2",settings.staff);
}


function fill(id,list){

  const el=document.getElementById(id);
  if(!el) return;

  el.innerHTML=`<option value="">-- Choisir --</option>`;

  list.forEach(v=>{
    el.innerHTML+=`<option>${v}</option>`;
  });
}



/* === IMAGE PREPROCESS === */

function preprocessImage(file){

  return new Promise(resolve=>{

    const img = new Image();
    const reader = new FileReader();

    reader.onload = e=>{
      img.src = e.target.result;
    };

    img.onload = ()=>{

      const canvas = document.createElement("canvas");
      const ctx = canvas.getContext("2d");

      canvas.width = img.width;
      canvas.height = img.height;

      ctx.drawImage(img,0,0);

      const image = ctx.getImageData(0,0,canvas.width,canvas.height);
      const d = image.data;

      for(let i=0;i<d.length;i+=4){

        // Gris pond√©r√© (meilleur OCR)
        let g = 0.3*d[i] + 0.59*d[i+1] + 0.11*d[i+2];

        // Contraste doux
        g = (g - 128) * 1.25 + 128;

        // Clamp
        g = Math.max(0, Math.min(255, g));

        d[i]=d[i+1]=d[i+2]=g;
      }

      ctx.putImageData(image,0,0);

      resolve(canvas);
    };

    reader.readAsDataURL(file);
  });
}
/* === OCR === */

async function scanBracelet(){

  const file = document.getElementById("scan").files[0];

  if(!file){
    alert("Prends une photo du bracelet");
    return;
  }

  const img = await preprocessImage(file);

  const result = await Tesseract.recognize(
    {
  tessedit_char_whitelist:
  "ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789()/ :-",
  preserve_interword_spaces: 1,
  tessedit_pageseg_mode: 6,
  logger: m => console.log(m)
}

  const text = result.data.text;

  console.log("OCR brut:", text);

  parseBracelet(text);
}


/* === PARSE === */

function parseBracelet(txt){

  txt = txt.replace(/\s+/g," ");

  console.log("Nettoy√©:",txt);

  // NOM + PRENOM
  const nameMatch = txt.match(/([A-Z]{3,}) ([A-Z]{3,})/);

  if(nameMatch){
    p_nom.value = nameMatch[1];
    p_prenom.value = nameMatch[2];
  }

  // DATE NAISSANCE
  const birth = txt.match(/\d{2}\/\d{2}\/\d{4}/);
  if(birth) p_naissance.value = birth[0];

  // SEXE
  const sex = txt.match(/\((M|F)\)/);
  if(sex) p_sexe.value = sex[1];

  // IPP
  const ipp = txt.match(/IPP[: ]*([0-9]{6,12})/i);
  if(ipp) p_ipp.value = ipp[1];

  // DOSSIER
  const dossier = txt.match(/\b3\d{7,8}\b/);
  if(dossier) p_dossier.value = dossier[0];

}

/* === INIT === */

render();
loadSettings();

</script>

</body>
</html>
